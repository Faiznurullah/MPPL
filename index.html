<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rust + WASM Snake Game</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #1a1a1a;
      color: white;
    }

    h1 {
      color: #4CAF50;
      margin-bottom: 20px;
    }

    #gameContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    #gameCanvas {
      border: 2px solid #4CAF50;
      background-color: #2d2d2d;
    }

    #gameInfo {
      display: flex;
      gap: 30px;
      font-size: 18px;
    }

    #score {
      color: #FFD700;
    }

    #gameStatus {
      color: #FF6B6B;
    }

    #controls {
      text-align: center;
      margin-top: 20px;
    }

    .control-group {
      margin: 10px 0;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #45a049;
    }

    .arrow-keys {
      display: grid;
      grid-template-columns: repeat(3, 50px);
      grid-template-rows: repeat(3, 50px);
      gap: 5px;
      justify-content: center;
      margin: 20px 0;
    }

    .arrow-key {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      padding: 0;
    }

    .arrow-key:nth-child(1) { grid-column: 2; grid-row: 1; } /* Up */
    .arrow-key:nth-child(2) { grid-column: 1; grid-row: 2; } /* Left */
    .arrow-key:nth-child(3) { grid-column: 3; grid-row: 2; } /* Right */
    .arrow-key:nth-child(4) { grid-column: 2; grid-row: 3; } /* Down */

    #instructions {
      text-align: center;
      margin-top: 20px;
      color: #ccc;
    }
  </style>
</head>
<body>
  <h1>Rust + WebAssembly Snake Game</h1>
  
  <div id="gameContainer">
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    
    <div id="gameInfo">
      <div>Score: <span id="score">0</span></div>
      <div id="gameStatus">Ready to Start</div>
    </div>

    <div id="controls">
      <div class="control-group">
        <button id="startButton">Start Game</button>
        <button id="pauseButton">Pause</button>
      </div>

      <div class="arrow-keys">
        <button class="arrow-key" id="upBtn">↑</button>
        <button class="arrow-key" id="leftBtn">←</button>
        <button class="arrow-key" id="rightBtn">→</button>
        <button class="arrow-key" id="downBtn">↓</button>
      </div>
    </div>

    <div id="instructions">
      <p>Use arrow keys or buttons to control the snake</p>
      <p>Eat the red food to grow and increase your score!</p>
    </div>
  </div>

  <script type="module">
    import init, { SnakeGame } from "./pkg/explore.js";

    let game;
    let gameLoop;
    let isGameRunning = false;
    let isPaused = false;
    let score = 0;
    
    const canvas = document.getElementById("gameCanvas");
     const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score");
     const statusEl = document.getElementById("gameStatus");
    const startBtn = document.getElementById("startButton");
    const pauseBtn = document.getElementById("pauseButton");
 
       const GRID_SIZE = 20;
     const CANVAS_SIZE = 400;
       const GAME_SPEED = 150;  

    async function run() {
      try {
        await init();
        game = new SnakeGame();
        setupControls();
        updateStatus("Game loaded! Click Start to play");
        drawGame();
      } catch (error) {
        console.error("Failed to initialize game:", error);
        updateStatus("Failed to load game");
      }
    }

    function setupControls() {
       
      startBtn.addEventListener("click", startGame);
      pauseBtn.addEventListener("click", togglePause);

       
      document.getElementById("upBtn").addEventListener("click", () => setDirection(0, -1));
      document.getElementById("downBtn").addEventListener("click", () => setDirection(0, 1));
      document.getElementById("leftBtn").addEventListener("click", () => setDirection(-1, 0));
      document.getElementById("rightBtn").addEventListener("click", () => setDirection(1, 0));
 
      document.addEventListener("keydown", (event) => {
        switch(event.key) {
          case "ArrowUp":
            event.preventDefault();
            setDirection(0, -1);
            break;
          case "ArrowDown":
            event.preventDefault();
            setDirection(0, 1);
            break;
          case "ArrowLeft":
            event.preventDefault();
            setDirection(-1, 0);
            break;
          case "ArrowRight":
            event.preventDefault();
            setDirection(1, 0);
            break;
          case " ": // Spacebar
            event.preventDefault();
            togglePause();
            break;
        }
      });
    }

    function startGame() {
      if (!game) return;
      
      try {
        game.start();
        isGameRunning = true;
        isPaused = false;
        score = 0;
        updateScore();
        updateStatus("Game Started!");
        startBtn.textContent = "Restart";
        
        if (gameLoop) {
          clearInterval(gameLoop);
        }
        
        gameLoop = setInterval(gameLoopFunction, GAME_SPEED);
      } catch (error) {
        console.error("Failed to start game:", error);
        updateStatus("Failed to start game");
      }
    }

    function togglePause() {
      if (!isGameRunning) return;
      
      isPaused = !isPaused;
      pauseBtn.textContent = isPaused ? "Resume" : "Pause";
      updateStatus(isPaused ? "Game Paused" : "Game Running");
    }

    function setDirection(x, y) {
      if (!game || !isGameRunning || isPaused) return;
      
      try {
        game.set_direction(x, y);
      } catch (error) {
        console.error("Failed to set direction:", error);
      }
    }

    function gameLoopFunction() {
      if (!isGameRunning || isPaused) return;
      
      try {
        game.update();
        
        if (game.check_collision()) {
          gameOver();
          return;
        }
        
        drawGame();
      } catch (error) {
        console.error("Game loop error:", error);
        gameOver();
      }
    }

    function gameOver() {
      isGameRunning = false;
      clearInterval(gameLoop);
      const finalScore = game ? game.get_score() : score;
      updateStatus(`Game Over! Final Score: ${finalScore}`);
      startBtn.textContent = "Start New Game";
    }

    function drawGame() {
      if (!game) return;
      
      try {
         
        ctx.fillStyle = "#2d2d2d";
        ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE); 

        const snakePositions = game.get_snake_positions();
        ctx.fillStyle = "#4CAF50";
        
        for (let i = 0; i < snakePositions.length; i++) {
          const position = snakePositions[i];
          const x = position[0] * GRID_SIZE;
          const y = position[1] * GRID_SIZE; 
          ctx.fillRect(x, y, GRID_SIZE - 1, GRID_SIZE - 1);
          
          
             if (i === 0) {
            ctx.fillStyle = "#66BB6A";
            ctx.fillRect(x + 2, y + 2, GRID_SIZE - 5, GRID_SIZE - 5);
            ctx.fillStyle = "#4CAF50";
          }
        }
         
        const foodX = game.get_food_x() * GRID_SIZE;
        const foodY = game.get_food_y() * GRID_SIZE;
        
        ctx.fillStyle = "#FF5722";
        ctx.fillRect(foodX, foodY, GRID_SIZE - 1, GRID_SIZE - 1);
         
        ctx.fillStyle = "#FF8A65";
        ctx.fillRect(foodX + 3, foodY + 3, GRID_SIZE - 7, GRID_SIZE - 7);
         
        const newScore = game.get_score();
        if (newScore !== score) {
          score = newScore;
          updateScore();
          updateStatus(`Score: ${score}! Keep going!`);
        }
        
      } catch (error) {
        console.error("Failed to draw game:", error);
      }
    }

    function updateScore() {
      scoreEl.textContent = score;
    }

    function updateStatus(message) {
      statusEl.textContent = message;
    }

    // Initialize the game
    run();
  </script>
</body>
</html>
